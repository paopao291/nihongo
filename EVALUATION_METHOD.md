# 予測アルゴリズムの評価方法

tomoeデータ（テンプレート）とユーザーの描画を以下の方法で比較しています：

## 1. 形状の距離（Shape Distance）

### 評価方法
- ストロークを等間隔にリサンプリング（単純なストロークは12点、複雑なストロークは20点）
- 対応する点同士のユークリッド距離を計算
- 全ての点の距離の平均を取る

### 特徴
- ストロークの点数の違いを吸収（リサンプリング）
- 複雑なストロークほど多くの点で評価
- キャンバスサイズに応じて正規化（320px → canvasSize）

```javascript
// 例：12点にリサンプリングして比較
userStroke: [(x1,y1), (x2,y2), ...] → 12点に変換
templateStroke: [(x1,y1), (x2,y2), ...] → 12点に変換
距離 = Σ(dist(userPoint[i], templatePoint[i])) / 12
```

## 2. 方向の類似度（Direction Similarity）

### 評価方法
- 始点から終点への方向ベクトルを計算
- 2つのベクトルの角度差のcosine類似度を計算（-1 to 1）
- 0-1の範囲に正規化

### 特徴
- ストロークの全体的な向きを評価
- 始点→終点の直線的な方向性のみ（途中の曲がりは考慮しない）

```javascript
userDir = atan2(endY - startY, endX - startX)
templateDir = atan2(endY - startY, endX - startX)
類似度 = cos(userDir - templateDir)
```

## 3. 位置マッチング（Position Matching）

### 始点・終点の位置
- ユークリッド距離で評価
- 許容範囲：キャンバスサイズの30%（最後のストロークは20%）
- 距離が小さいほど高いスコア

### 特徴
- 短いストローク（点や線）では重要度が高い
- 最後のストロークはより厳密に評価

```javascript
距離 = sqrt((userX - templateX)² + (userY - templateY)²)
スコア = max(0, 1 - 距離 / 許容範囲)
```

## 4. 閉鎖度（Closure）

### 評価方法
- 始点と終点の距離をストロークの総距離で割る
- 総距離の20%以下なら「閉じている」と判定
- 閉鎖度は0-1（1に近いほど閉じている）

### 特徴
- 輪を描くストローク（「お」の2ストローク目など）を識別
- ユーザーとテンプレートの閉鎖度の差を評価

```javascript
閉鎖距離 = dist(start, end)
総距離 = Σ(dist(point[i], point[i+1]))
閉鎖度 = max(0, 1 - (閉鎖距離/総距離) / 0.2)
```

## 5. 膨らみ方・方向性（Bulge Direction）

### 評価方法
- 特徴点の抽出：
  - 中間点（ストロークの中央）
  - 3/4地点（輪を描いた後の方向）
  - 中心点（最大・最小のx, y座標の中心）
  - 幅・高さ・アスペクト比
- 対応する特徴点同士の距離を評価

### 特徴
- 輪を描くストロークの「膨らみ方」を評価
- 3/4地点を重視（40%の重み）
- 「お」と「む」のような似たストロークを区別

```javascript
特徴点 = {
  中間点: stroke[length/2],
  3/4地点: stroke[length*0.75],
  中心: (minX+maxX)/2, (minY+maxY)/2,
  アスペクト比: height/width
}
類似度 = 重み付け平均(各特徴点の距離)
```

## 6. 重み付けスコア

ストロークの種類に応じて重みを調整：

### 複雑なストローク（6点以上、2ストローク目以降）
- 形状: 50点（最重要）
- 方向: 15点
- 始点: 8点
- 終点: 6点
- 閉鎖度: 7点
- 輪の一致: 2点
- 膨らみ方: 8-12点（輪を描く場合は12点）

### 短いストローク（3点以下、または最初のストローク）
- 形状: 25-28点
- 方向: 18点
- 始点: 20-28点（重要）
- 終点: 18-25点（重要、最後のストロークは25点）
- 閉鎖度: 6点
- 輪の一致: 2点

### 通常のストローク
- 形状: 45点
- 方向: 22点
- 始点: 13点
- 終点: 8点
- 閉鎖度: 10点
- 輪の一致: 2点

## 7. 全体のスコア計算

1. 各ストロークのスコアを合計
2. ストローク数で平均
3. 残りストローク数によるボーナス（最大10%）
4. 全ストローク完了時のボーナス（20%）
5. 全ストロークの終点位置の一致度による追加ボーナス（最大10%）

## 制限事項

### 現在の実装の限界
1. **順序依存**: ストロークは順番通りに比較（順序が違うと評価できない）
2. **簡易DTW**: 完全なDynamic Time Warpingではなく、リサンプリングベース
3. **スケール依存**: キャンバスサイズに応じて正規化するが、書き方の大きさに依存
4. **形状のみ**: 書き順（速度、圧力など）は考慮しない

### 改善の余地
- より高度な形状マッチング（Fréchet距離など）
- 書き順の柔軟性
- 学習ベースの重み付け
